<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Cold Call Picker</title>
	<style>
		:root {
			--bg: #0b1220;
			--panel: #0f172a;
			--card: #111827;
			--muted: #94a3b8;
			--text: #e5e7eb;
			--accent: #60a5fa;
			--accent-2: #22d3ee;
			--ring: rgba(96,165,250,.35);
		}
		* { box-sizing: border-box; }
		html, body { height: 100%; }
		body {
			margin: 0;
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
			background: radial-gradient(1200px 800px at 50% -20%, #1f2937 0%, var(--bg) 50%);
			color: var(--text);
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
			padding: 24px 16px 80px;
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			margin-bottom: 16px;
		}
		h1 { font-size: clamp(22px, 3vw, 28px); margin: 0; letter-spacing: .3px; }
		.actions { display: flex; gap: 8px; flex-wrap: wrap; }

		button, .btn {
			appearance: none;
			border: 1px solid #334155;
			background: linear-gradient(180deg, #0b1220, #0f172a);
			color: var(--text);
			padding: 10px 14px;
			border-radius: 12px;
			cursor: pointer;
			font-weight: 600;
			letter-spacing: .2px;
			box-shadow: 0 0 0 0 rgba(0,0,0,0);
			transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
		}
		button:hover { border-color: #475569; box-shadow: 0 0 0 3px var(--ring); }
		button:active { transform: translateY(1px) scale(.99); }
		button.primary { border-color: #1d4ed8; background: linear-gradient(180deg, #0b1220, #0b2250); }
		button.ghost { background: transparent; }

		/* Card stack */
		.stack-wrap {
			display: grid;
			place-items: center;
			margin: 16px auto 18px;
			min-height: 260px;
		}
		.card-stack {
			position: relative;
			width: min(560px, 92vw);
			height: clamp(200px, 35vw, 300px);
		}
		.card {
			position: absolute;
			top: 0; left: 0; right: 0; bottom: 0;
			margin: auto;
			border-radius: 20px;
			background: linear-gradient(180deg, #0f172a, #0b1220);
			border: 1px solid #1f2937;
			box-shadow: 0 20px 60px rgba(0,0,0,.45);
			display: grid;
			place-items: center;
			padding: 22px;
			transform-origin: 50% 80%;
			transition: transform .5s cubic-bezier(.2,.7,.2,1), opacity .5s ease;
			will-change: transform, opacity;
		}
		.card:nth-child(1) { transform: translateY(0) rotate(0deg) scale(1); z-index: 3; }
		.card:nth-child(2) { transform: translateY(10px) rotate(-2deg) scale(.98); opacity: .9; z-index: 2; }
		.card:nth-child(3) { transform: translateY(20px) rotate(3deg) scale(.96); opacity: .85; z-index: 1; }

		.card .name {
			font-size: clamp(24px, 6vw, 40px);
			font-weight: 800;
			letter-spacing: .4px;
			text-align: center;
			background: linear-gradient(90deg, var(--accent), var(--accent-2));
			-webkit-background-clip: text;
			background-clip: text;
			color: transparent;
		}
		.card .sub { color: var(--muted); margin-top: 10px; font-size: 14px; }

		.shuffle .card {
			animation: shuffle 650ms ease-in-out;
		}
		@keyframes shuffle {
			0%   { transform: translateY(0) rotate(0deg) scale(1); }
			30%  { transform: translateY(-18px) rotate(-4deg) scale(1.02); }
			60%  { transform: translateY(8px) rotate(5deg) scale(.99); }
			100% { transform: translateY(0) rotate(0deg) scale(1); }
		}

		/* Roster panel */
		.panel {
			background: linear-gradient(180deg, var(--panel), #0b1220);
			border: 1px solid #1f2937;
			border-radius: 16px;
			padding: 14px;
		}
		.controls {
			display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;
			margin-bottom: 8px;
		}
		.controls small { color: var(--muted); }

		.roster {
			display: grid;
			grid-template-columns: 1fr auto auto auto;
			gap: 10px 12px;
			align-items: center;
		}
		.roster .hdr { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .12em; }
		.roster .row { padding: 10px 8px; border-radius: 12px; background: rgba(148,163,184,.04); border: 1px solid #1e293b; display: contents; }
		.roster .namecell { font-weight: 600; }
		.count-pill { background:#0b1220; border:1px solid #1f2937; padding:6px 10px; border-radius: 999px; font-weight:700; min-width: 40px; text-align:center; }
		.pass-toggle { display: inline-flex; align-items: center; gap: 8px; }
		.pass-toggle input { width: 36px; height: 20px; appearance: none; background: #1f2937; border-radius: 999px; position: relative; outline: none; border:1px solid #334155; cursor: pointer; }
		.pass-toggle input::after { content:""; position:absolute; top:2px; left:2px; width:16px; height:16px; background:#94a3b8; border-radius:50%; transition: left .2s ease, background .2s ease; }
		.pass-toggle input:checked { background:#0b3a2a; border-color:#065f46; }
		.pass-toggle input:checked::after { left:18px; background:#22d3ee; }
		.pass-label { color: var(--muted); font-size: 12px; }

		.empty { color: var(--muted); text-align: center; padding: 20px 8px; }

		/* Modal */
		.modal-backdrop {
			position: fixed; inset: 0; display: none; place-items: center; background: rgba(2,6,23,.6); backdrop-filter: blur(2px); z-index: 50;
		}
		.modal-backdrop.show { display: grid; }
		.modal {
			width: min(700px, 92vw);
			background: linear-gradient(180deg, #0b1220, #0f172a);
			border: 1px solid #1f2937; border-radius: 16px; padding: 16px;
			box-shadow: 0 30px 80px rgba(0,0,0,.55);
		}
		.modal h2 { margin: 4px 0 8px; }
		.modal .row { display: grid; gap: 8px; }
		.modal textarea { width: 100%; min-height: 120px; padding: 12px; border-radius: 12px; background:#0b1220; color: var(--text); border:1px solid #1f2937; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
		.modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }

		.footer { display:flex; justify-content:center; gap:10px; margin-top: 38px; }
		.note { color: var(--muted); font-size: 12px; text-align:center; margin-top:6px; }
	</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>Cold Call Picker</h1>
			<div class="actions">
				<button id="openClass" class="ghost">Create / Edit Class</button>
				<button id="resetPasses" title="Clear all passes for today" class="ghost">Reset Passes</button>
				<button id="exportData" class="ghost" title="Download backup JSON">Export</button>
				<label class="ghost" style="padding:10px 14px; border-radius:12px; border:1px dashed #334155; cursor:pointer;">
					<input id="importFile" type="file" accept="application/json" hidden />Import
				</label>
			</div>
		</header>

		<div class="stack-wrap">
			<div id="cardStack" class="card-stack">
				<div class="card">
					<div class="name" id="cardName">Add your class to begin</div>
					<!-- <div class="sub">Paste a comma-separated list of students via the button above</div> -->
				</div>
				<div class="card" aria-hidden="true"></div>
				<div class="card" aria-hidden="true"></div>
			</div>
			<div class="footer">
				<button id="pickBtn" class="primary">Select Student</button>
				<button id="usedPassBtn" title="If the selected student already used a pass today, click here">This student already used a pass today</button>
			</div>
			<div class="note">Fairness rule: everyone is selected once before anyone is selected twice. Passes exclude students from today’s picks.</div>
		</div>

		<div class="panel">
			<div class="controls">
				<small id="classStats">No class loaded.</small>
			</div>
			<div id="roster" class="roster">
				<div class="hdr">Name</div>
				<div class="hdr" style="text-align:center;">Times Called</div>
				<div class="hdr" style="text-align:center;">Pass today</div>
				<div class="hdr" style="text-align:right;">Actions</div>
				<div class="empty" style="grid-column:1/-1;">Add a class to see your roster here.</div>
			</div>
		</div>
	</div>

	<!-- Modal for class creation -->
	<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
		<div class="modal">
			<h2 id="modalTitle">Create / Edit Class</h2>
			<div class="row">
				<label for="namesInput">Paste a comma-separated list of student names</label>
				<textarea id="namesInput" placeholder="e.g. Alex Kim, Priya Patel, Jordan Smith, ..."></textarea>
			</div>
			<div class="actions">
				<button id="cancelModal" class="ghost">Cancel</button>
				<button id="saveClass" class="primary">Save Class</button>
			</div>
		</div>
	</div>

	<script>
		// ===== Utilities & Storage =====
		const STORE_KEY = 'coldcall:students:v1';
		const PASS_DATE_KEY = 'coldcall:passDate';
		const META_KEY = 'coldcall:meta';

		function todayStr() {
			const d = new Date();
			const yyyy = d.getFullYear();
			const mm = String(d.getMonth() + 1).padStart(2, '0');
			const dd = String(d.getDate()).padStart(2, '0');
			return `${yyyy}-${mm}-${dd}`;
		}

		function loadState() {
			const arr = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
			return Array.isArray(arr) ? arr : [];
		}
		function saveState(students) {
			localStorage.setItem(STORE_KEY, JSON.stringify(students));
		}
		function loadMeta() {
			return JSON.parse(localStorage.getItem(META_KEY) || '{}');
		}
		function saveMeta(meta) {
			localStorage.setItem(META_KEY, JSON.stringify(meta));
		}

		function resetPassesIfNewDay() {
			const last = localStorage.getItem(PASS_DATE_KEY);
			const t = todayStr();
			if (last !== t) {
				const students = loadState();
				students.forEach(s => s.passToday = false);
				saveState(students);
				localStorage.setItem(PASS_DATE_KEY, t);
			}
		}

		function uid() { return Math.random().toString(36).slice(2, 9); }

		// ===== App State =====
		let students = [];
		let lastPickId = null; // for optional undo when marking pass-after-pick

		// ===== DOM =====
		const rosterEl = document.getElementById('roster');
		const classStatsEl = document.getElementById('classStats');
		const pickBtn = document.getElementById('pickBtn');
		const usedPassBtn = document.getElementById('usedPassBtn');
		const cardStack = document.getElementById('cardStack');
		const cardName = document.getElementById('cardName');

		const modalBackdrop = document.getElementById('modalBackdrop');
		const openClassBtn = document.getElementById('openClass');
		const cancelModalBtn = document.getElementById('cancelModal');
		const saveClassBtn = document.getElementById('saveClass');
		const namesInput = document.getElementById('namesInput');
		const resetPassesBtn = document.getElementById('resetPasses');
		const exportBtn = document.getElementById('exportData');
		const importFile = document.getElementById('importFile');

		// ===== Roster Render =====
		function renderRoster() {
			rosterEl.innerHTML = '';
			// Headers
			const headers = [
				['Name',''], ['Times Called','text-align:center;'], ['Pass today','text-align:center;'], ['Actions','text-align:right;']
			];
			headers.forEach(([txt, style]) => {
				const d = document.createElement('div'); d.className = 'hdr'; d.textContent = txt; if (style) d.style = style; rosterEl.appendChild(d);
			});

			if (!students.length) {
				const empty = document.createElement('div'); empty.className = 'empty'; empty.style.gridColumn = '1 / -1'; empty.textContent = 'Add a class to see your roster here.'; rosterEl.appendChild(empty);
				classStatsEl.textContent = 'No class loaded.';
				return;
			}

			let totalCalls = students.reduce((a, s) => a + (s.count || 0), 0);
			classStatsEl.textContent = `${students.length} students · ${totalCalls} total calls`;

			students.forEach(s => {
				const name = document.createElement('div');
				name.className = 'namecell';
				name.textContent = s.name;

				const count = document.createElement('div');
				count.style.textAlign = 'center';
				const pill = document.createElement('span');
				pill.className = 'count-pill'; pill.textContent = s.count || 0;
				count.appendChild(pill);

				const passCell = document.createElement('div');
				passCell.style.textAlign = 'center';
				const toggle = document.createElement('input');
				toggle.type = 'checkbox'; toggle.checked = !!s.passToday; toggle.addEventListener('change', () => { s.passToday = toggle.checked; saveState(students); });
				const wrap = document.createElement('label'); wrap.className = 'pass-toggle'; wrap.appendChild(toggle);
				const lab = document.createElement('span'); lab.className = 'pass-label'; lab.textContent = s.passToday ? 'Using pass' : 'Available'; toggle.addEventListener('change', () => { lab.textContent = toggle.checked ? 'Using pass' : 'Available'; });
				wrap.appendChild(lab); passCell.appendChild(wrap);

				const actions = document.createElement('div'); actions.style.textAlign = 'right';
				const minusBtn = document.createElement('button'); minusBtn.className = 'ghost'; minusBtn.textContent = '−1'; minusBtn.title = 'Decrement calls'; minusBtn.addEventListener('click', () => { s.count = Math.max(0, (s.count||0)-1); saveState(students); renderRoster(); });
				const plusBtn = document.createElement('button'); plusBtn.className = 'ghost'; plusBtn.textContent = '+1'; plusBtn.title = 'Increment calls'; plusBtn.addEventListener('click', () => { s.count = (s.count||0)+1; saveState(students); renderRoster(); });
				const rmBtn = document.createElement('button'); rmBtn.className = 'ghost'; rmBtn.textContent = 'Remove'; rmBtn.title = 'Remove student'; rmBtn.addEventListener('click', () => { if (confirm(`Remove ${s.name}?`)) { students = students.filter(x => x.id !== s.id); saveState(students); renderRoster(); }});
				actions.append(minusBtn, plusBtn, rmBtn);

				// Append in grid order
				rosterEl.append(name, count, passCell, actions);
			});
		}

		// ===== Picking Logic (fairness with randomness) =====
		function eligibleStudents() {
			return students.filter(s => !s.passToday);
		}

		function pickStudent() {
			const eligible = eligibleStudents();
			if (!eligible.length) return null;
			const minCount = Math.min(...eligible.map(s => s.count || 0));
			const tier = eligible.filter(s => (s.count||0) === minCount);
			const idx = Math.floor(Math.random() * tier.length);
			return tier[idx] || null;
		}

		function animateShuffleAndShow(name) {
			cardStack.classList.remove('shuffle');
			// Force reflow to restart animation
			void cardStack.offsetWidth;
			cardStack.classList.add('shuffle');
			setTimeout(() => {
				cardName.textContent = name;
			}, 330);
		}

		pickBtn.addEventListener('click', () => {
			if (!students.length) { openModal(); return; }
			resetPassesIfNewDay();
			const s = pickStudent();
			if (!s) { animateShuffleAndShow('No eligible students (all on pass)'); return; }
			animateShuffleAndShow(s.name);
			// Count immediately, but allow one-step undo via "used pass" button.
			s.count = (s.count || 0) + 1;
			lastPickId = s.id;
			saveState(students);
			renderRoster();
		});

		usedPassBtn.addEventListener('click', () => {
			if (!lastPickId) return;
			const s = students.find(x => x.id === lastPickId);
			if (!s) return;
			// Undo the increment and mark pass for today
			s.count = Math.max(0, (s.count||0) - 1);
			s.passToday = true;
			saveState(students);
			renderRoster();
			// Update card subtext to reflect pass usage
			animateShuffleAndShow(`${s.name} — marked as pass today`);
			lastPickId = null;
		});

		// ===== Modal / Class handling =====
		function openModal() {
			const existing = loadState();
			if (existing.length) {
				namesInput.value = existing.map(s => s.name).join(', ');
			}
			modalBackdrop.classList.add('show');
			setTimeout(() => namesInput.focus(), 50);
		}
		function closeModal() { modalBackdrop.classList.remove('show'); }

		openClassBtn.addEventListener('click', openModal);
		cancelModalBtn.addEventListener('click', closeModal);
		modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

		saveClassBtn.addEventListener('click', () => {
			const raw = namesInput.value || '';
			let parsed = raw.split(',').map(n => n.trim()).filter(Boolean);
			parsed = Array.from(new Set(parsed)); // unique
			if (!parsed.length) { alert('Please paste at least one name.'); return; }

			// Merge with existing to preserve counts where names match (case-insensitive)
			const byLower = new Map(students.map(s => [s.name.toLowerCase(), s]));
			students = parsed.map(name => {
				const hit = byLower.get(name.toLowerCase());
				return hit ? { ...hit, name } : { id: uid(), name, count: 0, passToday: false };
			});
			saveState(students);
			renderRoster();
			closeModal();
			cardName.textContent = 'Class updated — ready to pick';
		});

		resetPassesBtn.addEventListener('click', () => {
			students.forEach(s => s.passToday = false);
			saveState(students);
			localStorage.setItem(PASS_DATE_KEY, todayStr());
			renderRoster();
		});

		// Export / Import (optional safety for #3)
		exportBtn.addEventListener('click', () => {
			const payload = { version: 1, date: new Date().toISOString(), students };
			const blob = new Blob([JSON.stringify(payload, null, 1)], { type: 'application/json' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url; a.download = 'coldcall-backup.json'; a.click();
			URL.revokeObjectURL(url);
		});
		importFile.addEventListener('change', (e) => {
			const file = e.target.files?.[0]; if (!file) return;
			const reader = new FileReader();
			reader.onload = () => {
				try {
					const data = JSON.parse(reader.result);
					if (!data.students || !Array.isArray(data.students)) throw new Error('Invalid file');
					students = data.students.map(s => ({ id: s.id || uid(), name: String(s.name||'').trim(), count: Number(s.count||0), passToday: !!s.passToday }));
					saveState(students); renderRoster(); cardName.textContent = 'Imported class — ready to pick';
				} catch (err) { alert('Import failed: ' + err.message); }
			};
			reader.readAsText(file);
			// reset input value to allow re-importing same file later
			e.target.value = '';
		});

		// ===== Init =====
		(function init() {
			resetPassesIfNewDay();
			students = loadState();
			renderRoster();
			if (students.length) { cardName.textContent = 'Ready to pick'; }
		})();
	</script>
</body>
</html>
